rule win_bazarbackdoor_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-10-07"
        version = "1"
        description = "Detects win.bazarbackdoor."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor"
        malpedia_rule_date = "20211007"
        malpedia_hash = "e5b790e0f888f252d49063a1251ca60ec2832535"
        malpedia_version = "20211008"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 41b80f100000 488bce 4889442420 ff15???????? }
            // n = 4, score = 1100
            //   41b80f100000         | inc                 ecx
            //   488bce               | mov                 eax, 0x100f
            //   4889442420           | dec                 eax
            //   ff15????????         |                     

        $sequence_1 = { 4889442420 ff15???????? 85c0 780a }
            // n = 4, score = 1100
            //   4889442420           | xor                 eax, eax
            //   ff15????????         |                     
            //   85c0                 | mov                 dword ptr [esp + 0x20], 2
            //   780a                 | mov                 edx, 0x40000000

        $sequence_2 = { 4533c9 4533c0 c744242002000000 ba00000040 ffd0 }
            // n = 5, score = 1100
            //   4533c9               | inc                 ebp
            //   4533c0               | xor                 ecx, ecx
            //   c744242002000000     | inc                 ebp
            //   ba00000040           | xor                 eax, eax
            //   ffd0                 | mov                 dword ptr [esp + 0x20], 2

        $sequence_3 = { 498bf0 488bea 4c8bf1 33db }
            // n = 4, score = 1100
            //   498bf0               | mov                 dword ptr [esp + 0x28], 0x80
            //   488bea               | inc                 ebp
            //   4c8bf1               | xor                 ecx, ecx
            //   33db                 | inc                 ebp

        $sequence_4 = { 0fb6c8 e8???????? 85c0 7403 }
            // n = 4, score = 1100
            //   0fb6c8               | cmp                 dword ptr [ecx + 0x18], 4
            //   e8????????           |                     
            //   85c0                 | jne                 0x66
            //   7403                 | mov                 eax, dword ptr [ecx + 0x20]

        $sequence_5 = { 7507 33c0 e9???????? b8ff000000 }
            // n = 4, score = 1000
            //   7507                 | inc                 ecx
            //   33c0                 | mov                 eax, 0x100f
            //   e9????????           |                     
            //   b8ff000000           | dec                 eax

        $sequence_6 = { 4084ff 400f94c7 0fb6c8 e8???????? }
            // n = 4, score = 1000
            //   4084ff               | mov                 dword ptr [esp + 0x20], 2
            //   400f94c7             | mov                 edx, 0x40000000
            //   0fb6c8               | mov                 dword ptr [esp + 0x28], 0x80
            //   e8????????           |                     

        $sequence_7 = { ebd2 3c20 7709 48ffc3 8a03 }
            // n = 5, score = 1000
            //   ebd2                 | inc                 eax
            //   3c20                 | test                bh, bh
            //   7709                 | je                  0x28
            //   48ffc3               | je                  0x33
            //   8a03                 | inc                 eax

        $sequence_8 = { 8a03 3c20 7709 84c0 7431 4084ff }
            // n = 6, score = 1000
            //   8a03                 | xor                 bh, bh
            //   3c20                 | mov                 al, byte ptr [ebx]
            //   7709                 | cmp                 al, 0x20
            //   84c0                 | ja                  0x12
            //   7431                 | dec                 eax
            //   4084ff               | cmovne              ebx, eax

        $sequence_9 = { 84c0 7431 4084ff 741f 3c22 7507 4084ff }
            // n = 7, score = 1000
            //   84c0                 | cmp                 al, 0x20
            //   7431                 | ja                  0xf
            //   4084ff               | inc                 eax
            //   741f                 | xor                 bh, bh
            //   3c22                 | mov                 al, byte ptr [ebx]
            //   7507                 | cmp                 al, 0x20
            //   4084ff               | ja                  0xf

        $sequence_10 = { 488bcf ffd0 488905???????? 4885c0 750a b806000000 }
            // n = 6, score = 900
            //   488bcf               | inc                 ebp
            //   ffd0                 | xor                 eax, eax
            //   488905????????       |                     
            //   4885c0               | mov                 dword ptr [esp + 0x20], 2
            //   750a                 | mov                 edx, 0x40000000
            //   b806000000           | call                eax

        $sequence_11 = { 41b989010000 41b841587c4c e8???????? 4885c0 740a }
            // n = 5, score = 900
            //   41b989010000         | inc                 eax
            //   41b841587c4c         | sete                bh
            //   e8????????           |                     
            //   4885c0               | movzx               ecx, al
            //   740a                 | test                eax, eax

        $sequence_12 = { e8???????? cc e8???????? cc 4053 4883ec20 b902000000 }
            // n = 7, score = 900
            //   e8????????           |                     
            //   cc                   | sete                bh
            //   e8????????           |                     
            //   cc                   | movzx               ecx, al
            //   4053                 | je                  0x21
            //   4883ec20             | cmp                 al, 0x22
            //   b902000000           | jne                 0xb

        $sequence_13 = { e8???????? 4885c0 7407 b9b80b0000 ffd0 }
            // n = 5, score = 900
            //   e8????????           |                     
            //   4885c0               | inc                 ebx
            //   7407                 | mov                 al, byte ptr [ebx]
            //   b9b80b0000           | test                al, al
            //   ffd0                 | inc                 eax

        $sequence_14 = { 33d2 488bc8 ff15???????? ff15???????? 4c8bc3 }
            // n = 5, score = 900
            //   33d2                 | inc                 eax
            //   488bc8               | test                bh, bh
            //   ff15????????         |                     
            //   ff15????????         |                     
            //   4c8bc3               | je                  0x24

        $sequence_15 = { 750a b834000000 e9???????? 660f6f05???????? }
            // n = 4, score = 900
            //   750a                 | dec                 eax
            //   b834000000           | mov                 edi, eax
            //   e9????????           |                     
            //   660f6f05????????     |                     

        $sequence_16 = { 4885c9 7406 488b11 ff5210 ff15???????? }
            // n = 5, score = 900
            //   4885c9               | mov                 ecx, esi
            //   7406                 | dec                 eax
            //   488b11               | mov                 dword ptr [esp + 0x20], eax
            //   ff5210               | test                eax, eax
            //   ff15????????         |                     

        $sequence_17 = { ff15???????? ff15???????? 4d8bc5 33d2 488bc8 }
            // n = 5, score = 800
            //   ff15????????         |                     
            //   ff15????????         |                     
            //   4d8bc5               | inc                 eax
            //   33d2                 | sete                bh
            //   488bc8               | movzx               ecx, al

        $sequence_18 = { b902000000 e8???????? e8???????? 8bc8 e8???????? e8???????? 8bd8 }
            // n = 7, score = 700
            //   b902000000           | jmp                 0xffffffd4
            //   e8????????           |                     
            //   e8????????           |                     
            //   8bc8                 | cmp                 al, 0x20
            //   e8????????           |                     
            //   e8????????           |                     
            //   8bd8                 | ja                  0xf

        $sequence_19 = { 0fb70f ff15???????? 0fb74f02 0fb7d8 ff15???????? }
            // n = 5, score = 700
            //   0fb70f               | inc                 eax
            //   ff15????????         |                     
            //   0fb74f02             | sete                bh
            //   0fb7d8               | movzx               ecx, al
            //   ff15????????         |                     

        $sequence_20 = { 0fb64b04 0fb6d1 80f973 7504 0fb65305 33c0 }
            // n = 6, score = 700
            //   0fb64b04             | inc                 eax
            //   0fb6d1               | xor                 bh, bh
            //   80f973               | mov                 al, byte ptr [ebx]
            //   7504                 | cmp                 al, 0x20
            //   0fb65305             | ja                  0xd
            //   33c0                 | test                al, al

        $sequence_21 = { 8bd3 e8???????? 33c0 e9???????? }
            // n = 4, score = 700
            //   8bd3                 | test                bh, bh
            //   e8????????           |                     
            //   33c0                 | inc                 eax
            //   e9????????           |                     

        $sequence_22 = { 84d2 7405 80fa2e 750f 0fb6c1 }
            // n = 5, score = 600
            //   84d2                 | inc                 eax
            //   7405                 | sete                bh
            //   80fa2e               | movzx               ecx, al
            //   750f                 | test                eax, eax
            //   0fb6c1               | je                  0xa

        $sequence_23 = { c3 0fb74c0818 b80b010000 663bc8 }
            // n = 4, score = 500
            //   c3                   | push                esi
            //   0fb74c0818           | push                edi
            //   b80b010000           | push                ebp
            //   663bc8               | push                ebx

        $sequence_24 = { 6685ff 0f849c000000 837c2460ff 0f858c000000 }
            // n = 4, score = 400
            //   6685ff               | test                bh, bh
            //   0f849c000000         | inc                 eax
            //   837c2460ff           | test                bh, bh
            //   0f858c000000         | je                  0x21

        $sequence_25 = { 66890d???????? 0fb7ca ff15???????? b901000000 }
            // n = 4, score = 400
            //   66890d????????       |                     
            //   0fb7ca               | inc                 eax
            //   ff15????????         |                     
            //   b901000000           | xor                 bh, bh

        $sequence_26 = { ffd0 90 4883c430 5b }
            // n = 4, score = 400
            //   ffd0                 | mov                 al, byte ptr [ebx]
            //   90                   | cmp                 al, 0x20
            //   4883c430             | ja                  0xd
            //   5b                   | test                al, al

        $sequence_27 = { e8???????? 4c897c2420 4889d9 89fa }
            // n = 4, score = 400
            //   e8????????           |                     
            //   4c897c2420           | je                  0x39
            //   4889d9               | inc                 eax
            //   89fa                 | test                bh, bh

        $sequence_28 = { 89e8 4883c448 5b 5d 5f 5e 415c }
            // n = 7, score = 400
            //   89e8                 | je                  0x2c
            //   4883c448             | ja                  0xb
            //   5b                   | test                al, al
            //   5d                   | je                  0x35
            //   5f                   | inc                 eax
            //   5e                   | test                bh, bh
            //   415c                 | ja                  0xb

        $sequence_29 = { a1???????? 53 56 8b742410 85c0 }
            // n = 5, score = 400
            //   a1????????           |                     
            //   53                   | inc                 eax
            //   56                   | sete                bh
            //   8b742410             | movzx               ecx, al
            //   85c0                 | test                eax, eax

        $sequence_30 = { 51 ffd0 8b4df4 64890d00000000 }
            // n = 4, score = 400
            //   51                   | inc                 eax
            //   ffd0                 | sete                bh
            //   8b4df4               | movzx               ecx, al
            //   64890d00000000       | test                eax, eax

        $sequence_31 = { 75c5 c6443c1000 84db 7402 ff06 8d4c2410 }
            // n = 6, score = 400
            //   75c5                 | inc                 eax
            //   c6443c1000           | test                bh, bh
            //   84db                 | inc                 eax
            //   7402                 | test                bh, bh
            //   ff06                 | je                  0x21
            //   8d4c2410             | cmp                 al, 0x22

        $sequence_32 = { 4155 4154 56 57 55 53 4881ec98010000 }
            // n = 7, score = 400
            //   4155                 | inc                 eax
            //   4154                 | test                bh, bh
            //   56                   | je                  0x28
            //   57                   | cmp                 al, 0x22
            //   55                   | je                  5
            //   53                   | dec                 eax
            //   4881ec98010000       | inc                 ebx

        $sequence_33 = { 03c3 50 8b840a04010000 03c5 }
            // n = 4, score = 400
            //   03c3                 | xor                 bh, bh
            //   50                   | mov                 al, byte ptr [ebx]
            //   8b840a04010000       | cmp                 al, 0x20
            //   03c5                 | ja                  0x12

        $sequence_34 = { 75e5 33c0 5f 5e 59 }
            // n = 5, score = 400
            //   75e5                 | je                  0xe
            //   33c0                 | dec                 eax
            //   5f                   | inc                 ebx
            //   5e                   | movzx               ecx, al
            //   59                   | test                eax, eax

        $sequence_35 = { 0fb745ea 50 0fb745e8 50 68???????? e8???????? }
            // n = 6, score = 400
            //   0fb745ea             | movzx               ecx, al
            //   50                   | test                eax, eax
            //   0fb745e8             | je                  0xa
            //   50                   | dec                 eax
            //   68????????           |                     
            //   e8????????           |                     

        $sequence_36 = { 56 57 53 4883ec20 4889d7 }
            // n = 5, score = 400
            //   56                   | inc                 eax
            //   57                   | test                bh, bh
            //   53                   | je                  0x28
            //   4883ec20             | cmp                 al, 0x22
            //   4889d7               | jne                 0x14

        $sequence_37 = { 0fbe1f 85db 7e0c 8d742411 }
            // n = 4, score = 400
            //   0fbe1f               | test                al, al
            //   85db                 | je                  0x3e
            //   7e0c                 | inc                 eax
            //   8d742411             | test                bh, bh

        $sequence_38 = { ff7508 56 ff15???????? 6a00 }
            // n = 4, score = 300
            //   ff7508               | mov                 al, byte ptr [ebx]
            //   56                   | cmp                 al, 0x20
            //   ff15????????         |                     
            //   6a00                 | ja                  0xf

        $sequence_39 = { c644244421 c644244569 c64424467b c64424477a }
            // n = 4, score = 300
            //   c644244421           | ja                  0x12
            //   c644244569           | dec                 eax
            //   c64424467b           | inc                 ebx
            //   c64424477a           | mov                 al, byte ptr [ebx]

        $sequence_40 = { 46 42 8d4701 84c9 }
            // n = 4, score = 300
            //   46                   | inc                 eax
            //   42                   | test                bh, bh
            //   8d4701               | inc                 eax
            //   84c9                 | sete                bh

        $sequence_41 = { 0fb7d8 0fb74708 50 ff15???????? 0fb7c8 83fe01 }
            // n = 6, score = 300
            //   0fb7d8               | dec                 eax
            //   0fb74708             | inc                 ebx
            //   50                   | dec                 eax
            //   ff15????????         |                     
            //   0fb7c8               | inc                 ebx
            //   83fe01               | cmp                 al, 0x22

        $sequence_42 = { c64424413b c644244224 c644244321 c644244421 c644244569 }
            // n = 5, score = 300
            //   c64424413b           | cmp                 al, 0x20
            //   c644244224           | ja                  0x16
            //   c644244321           | test                al, al
            //   c644244421           | dec                 eax
            //   c644244569           | inc                 ebx

        $sequence_43 = { c744242880000000 c744242003000000 4889f1 ba00000080 }
            // n = 4, score = 300
            //   c744242880000000     | inc                 eax
            //   c744242003000000     | xor                 bh, bh
            //   4889f1               | mov                 al, byte ptr [ebx]
            //   ba00000080           | cmp                 al, 0x20

        $sequence_44 = { e8???????? 4889f9 4889da ffd0 }
            // n = 4, score = 300
            //   e8????????           |                     
            //   4889f9               | ja                  0xf
            //   4889da               | test                al, al
            //   ffd0                 | dec                 eax

        $sequence_45 = { 8d4601 50 ff15???????? 83f8ff }
            // n = 4, score = 300
            //   8d4601               | jne                 9
            //   50                   | inc                 eax
            //   ff15????????         |                     
            //   83f8ff               | test                bh, bh

        $sequence_46 = { 53 8b1d???????? ffd3 8b3d???????? 8d7001 8d4610 50 }
            // n = 7, score = 300
            //   53                   | mov                 al, byte ptr [ebx]
            //   8b1d????????         |                     
            //   ffd3                 | cmp                 al, 0x20
            //   8b3d????????         |                     
            //   8d7001               | ja                  0xd
            //   8d4610               | test                al, al
            //   50                   | je                  0x39

        $sequence_47 = { 6a2e 6a00 50 ff15???????? }
            // n = 4, score = 300
            //   6a2e                 | mov                 al, byte ptr [ebx]
            //   6a00                 | cmp                 al, 0x20
            //   50                   | ja                  0x12
            //   ff15????????         |                     

        $sequence_48 = { fec8 88041a 8bd1 41 }
            // n = 4, score = 300
            //   fec8                 | inc                 eax
            //   88041a               | sete                bh
            //   8bd1                 | movzx               ecx, al
            //   41                   | cmp                 al, 0x22

        $sequence_49 = { 7404 3c2e 750b 8ac1 2ac2 fec8 88041a }
            // n = 7, score = 300
            //   7404                 | movzx               ecx, al
            //   3c2e                 | test                eax, eax
            //   750b                 | inc                 eax
            //   8ac1                 | sete                bh
            //   2ac2                 | movzx               ecx, al
            //   fec8                 | test                eax, eax
            //   88041a               | je                  0xa

        $sequence_50 = { 57 53 4883ec58 4989ce }
            // n = 4, score = 300
            //   57                   | test                al, al
            //   53                   | je                  0x3e
            //   4883ec58             | inc                 eax
            //   4989ce               | xor                 bh, bh

        $sequence_51 = { e8???????? 4889f9 4889f2 ffd0 }
            // n = 4, score = 300
            //   e8????????           |                     
            //   4889f9               | pop                 ebp
            //   4889f2               | pop                 edi
            //   ffd0                 | pop                 esi

        $sequence_52 = { ff15???????? 488906 4885c0 7425 }
            // n = 4, score = 300
            //   ff15????????         |                     
            //   488906               | inc                 eax
            //   4885c0               | xor                 bh, bh
            //   7425                 | mov                 al, byte ptr [ebx]

        $sequence_53 = { 0f848c000000 488b442430 83782000 7460 }
            // n = 4, score = 100
            //   0f848c000000         | cmp                 cl, 0x73
            //   488b442430           | sete                al
            //   83782000             | jne                 6
            //   7460                 | movzx               edx, byte ptr [ebx + 5]

        $sequence_54 = { 0f8398000000 488b442418 0fb700 c1f80c }
            // n = 4, score = 100
            //   0f8398000000         | dec                 ebp
            //   488b442418           | mov                 eax, ebp
            //   0fb700               | xor                 edx, edx
            //   c1f80c               | jne                 0x2a

        $sequence_55 = { 0bc8 8bc1 0fbaf019 8944245c }
            // n = 4, score = 100
            //   0bc8                 | sete                bh
            //   8bc1                 | movzx               ecx, al
            //   0fbaf019             | dec                 eax
            //   8944245c             | inc                 ebx

        $sequence_56 = { 034110 8bc0 448bc0 488b542460 }
            // n = 4, score = 100
            //   034110               | je                  0x3b
            //   8bc0                 | inc                 eax
            //   448bc0               | test                bh, bh
            //   488b542460           | inc                 eax

        $sequence_57 = { 03842480000000 488b4c2428 8901 eb2d }
            // n = 4, score = 100
            //   03842480000000       | cmp                 al, 0x20
            //   488b4c2428           | ja                  0xb
            //   8901                 | test                al, al
            //   eb2d                 | je                  0x37

        $sequence_58 = { 034110 8bc0 4889442478 488b442470 }
            // n = 4, score = 100
            //   034110               | sete                bh
            //   8bc0                 | movzx               ecx, al
            //   4889442478           | test                eax, eax
            //   488b442470           | je                  0xa

        $sequence_59 = { 0bc8 8bc1 8944245c 8b442424 }
            // n = 4, score = 100
            //   0bc8                 | test                bh, bh
            //   8bc1                 | inc                 eax
            //   8944245c             | sete                bh
            //   8b442424             | movzx               ecx, al

        $sequence_60 = { 0f8483020000 488b442428 8b400c 488b4c2438 }
            // n = 4, score = 100
            //   0f8483020000         | cmp                 cl, 0x73
            //   488b442428           | jne                 6
            //   8b400c               | movzx               edx, byte ptr [ebx + 5]
            //   488b4c2438           | xor                 eax, eax

    condition:
        7 of them and filesize < 675840
}