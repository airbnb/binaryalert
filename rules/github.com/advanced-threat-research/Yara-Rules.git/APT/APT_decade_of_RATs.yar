import "pe"

rule pwnlnx_backdoor_variant_1 {

    meta:
    
        description = "Rule to detect the backdoor pwnlnx variant 1"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "0f6033d6f82ce758b576e2d8c483815e908e323d0b700040fbdab5593fb5282b"
    
    strings:

        /*

        7F454C4602010100000000000000000002003E0001000000101A4000000000004000000000000000608C0000000000000000000040003800080040001D001A000600000005000000400000000000000040004000000000004000400000000000C001000000000000C001000000000000080000000000000003000000040000000002000000000000000240000000000000024000000000001C000000000000001C0000000000000001000000000000000100000005000000000000000000000000004000000000000000400000000000E476000000000000E476000000000000000020000000000001000000060000000080000000000000008060000000000000806000000000003808000000000000800C00000000000000002000000000000200000006000000288000000000000028806000000000002880600000000000A001000000000000A001000000000000080000000000000004000000040000001C020000000000001C024000000000001C0240000000000020000000000000002000000000000000040000000000000050E57464040000009C6D0000000000009C6D4000000000009C6D400000000000DC01000000000000DC01000000000000040000000000000051E57464060000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000002F6C696236342F6C642D6C696E75782D7838362D36342E736F2E3200040000001000000001000000474E5500000000000200000006000000090000000000000002000000500000000100000006000000000000000200002000000000500000007DF85A5800000000000000000000000000000000000000000000000000000000150100001200000000000000000000004101000000000000820100001200000000000000000000002500000000000000A301000012000000000000000000000025000000000000005300000012000000000000000000000062000000000000006A0100001200000000000000000000001B0B0000000000007E0200001200000000000000000000008B00000000000000490200001200000000000000000000002500000000000000BD0100001200000000000000000000006C00000000000000590000001200000000000000000000008E00000000000000F4010000120000000000000000000000250000000000000088010000120000000000000000000000F200000000000000FA010000120000000000000000000000A9010000000000000100000020000000000000000000000000000000000000001000000020000000000000000000000000000000000000005002000012000000000000000000000025000000000000007C010000120000000000000000000000EE00000000000000D20000001200000000000000000000000800000000000000230100001200000000000000000000009700000000000000CD000000120000000000000000000000F100000000000000170200001200000000000000000000008000000000000000CE010000120000000000000000000000240200000000000066020000120000000000000000000000A501000000000000710100001200000000000000000000002500000000000000C301000012000000000000000000000028000000000000009B010000120000000000000000000000E700000000000000380100001200000000000000000000003300000000000000E80000001200000000000000000000002901000000000000870200001200000000000000000000008A010000000000003D000000120000000000000000000000340C000000000000EC01000012000000000000000000000043000000000000004B01000012000000000000000000000025000000000000001C0100001200000000000000000000002500000000000000DC010000120000000000000000000000AB0400000000000078020000120000000000000000000000080000000000000043020000120000000000000000000000B9010000000000008C0000001200000000000000000000000A000000000000003F01000012000000000000000000000025000000000000005F020000120000000000000000000000F000000000000000D5010000120000000000000000000000BC010000000000002F020000120000000000000000000000EC01000000000000900100001200000000000000000000002800000000000000840000001200000000000000000000008000000000000000080200001200000000000000000000002700000000000000560200001200000000000000000000007401000000000000BF0000001200000000000000000000002500000000000000160200001200000000000000000000004601000000000000FA00000012000000000000000000000087000000000000005E0000001200000000000000000000001100000000000000A801000012000000000000000000000044000000000000001C0200001200000000000000000000005A00000000000000040100001200000000000000000000002901000000000000C6000000120000000000000000000000DC0000000000000044010000120000000000000000000000F100000000000000D80000001200000000000000000000006C00000000000000A00000001200000000000000000000005200000000000000BC0100001200000000000000000000000602000000000000E5010000120000000000000000000000340000000000000034000000120000000000000000000000A1000000000000000D010000120000000000000000000000A6000000000000008C0200001200000000000000000000004B00000000000000F10000001200000000000000000000002A000000000000006F00000012000000000000000000000005000000000000005E010000120000000000000000000000310000000000000074000000120000000000000000000000FF000000000000005E02000012000000000000000000000007000000000000004C000000120000000000000000000000A1000000000000007701000012000000000000000000000025000000000000000F0200001200000000000000000000006301000000000000DE0000001200000000000000000000007B01000000000000300100001200000000000000000000007504000000000000D90000001200000000000000000000000E00000000000000250200001200000000000000000000001100000000000000100200001200000000000000000000008000000000000000990000001200000000000000000000008000000000000000AF000000120000000000000000000000C20000000000000039020000120000000000000000000000C0000000000000002A01000012000000000000000000000025000000000000008B0100001200000000000000000000001200000000000000B20100001200000000000000000000006501000000000000520100001200000020174000000000001300000000000000005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573006C6962707468726561642E736F2E30007265637666726F6D00707468726561645F6372656174650073656E64746F0070617573650077616974005F5F6572726E6F5F6C6F636174696F6E00666F726B00707468726561645F7369676D61736B00636F6E6E65637400707468726561645F73656C660061636365707400707468726561645F6465746163680066636E746C006C6962632E736F2E3600736F636B65740073747263707900657869740068746F6E73007372616E6400696E65745F61746F6E00676574707775696400636C6F736564697200696E65745F6E746F61006765746772676964007374726E637079006461656D6F6E006C697374656E0073656C656374006D6B646972007265616C6C6F6300676574706964006B696C6C00737472746F6B006C63686F776E00616C706861736F7274363400736967656D707479736574006D656D73657400726D6469720062696E6400667365656B0063686469720061736374696D6500676574736F636B6F7074006772616E74707400647570320073696761646473657400696E65745F616464720066636C6F736500736574736F636B6F7074006D616C6C6F6300737472636174007265616C706174680072656D6F7665006F70656E64697200696F63746C00676574686F737462796E616D65006578656376650066777269746500667265616400756E6C6F636B7074006C6F63616C74696D65007363616E64697236340072656164646972363400736C6565700073657473696400756E616D65006D656D6D6F766500666F70656E3634005F5F6C6962635F73746172745F6D61696E006E746F687300736E7072696E74660066726565005F5F7873746174363400474C4942435F322E322E3500474C4942435F322E3300000002000200020003000200020002000300030002000200020000000000020002000200020002000300020002000200020002000200020002000300020002000200040002000200030002000300020002000200030002000200020002000200030002000200020002000200020003000200020003000200020002000300020003000200030002000200020002000200020003000300030002000200020002000200000001000100240000001000000020000000751A690900000300960200000000000001000200B500000010000000000000001369690D00000400A202000010000000751A6909000002009602000000000000C881600000000000060000000D0000000000000000000000E88160000000000007000000010000000000000000000000F08160000000000007000000020000000000000000000000F881600000000000070000000300000000000000000000000082600000000000070000000400000000000000000000000882600000000000070000000500000000000000000000001082600000000000070000000600000000000000000000001882600000000000070000000700000000000000000000002082600000000000070000000800000000000000000000002882600000000000070000000900000000000000000000003082600000000000070000000A00000000000000000000003882600000000000070000000B00000000000000000000004082600000000000070000000C00000000000000000000004882600000000000070000000F00000000000000000000005082600000000000070000001000000000000000000000005882600000000000070000001100000000000000000000006082600000000000070000001200000000000000000000006882600000000000070000001300000000000000000000007082600000000000070000001400
        
        */

        $bp = { 7F??4C4602??01??000000000000000002??3E????0000????1A????0000000040000000000000??????0000000000000000000040??????????????1D????????0000????????????000000000000??????4000000000??????4000000000????01??00000000????01??00000000????000000000000????0000??????0000????000000000000????4000000000000002????000000001C??0000000000001C??00000000000001??00000000000001??000005????????0000000000000000??????0000000000004000000000????76??00000000????76??000000000000????00000000????0000????0000000080????00000000????????????0000????????????000038??00000000000080??????00000000000020??0000000002??0000060000????80????0000000028??????????000028??????????0000A0????????0000????????????0000????000000000000??????000004??00001C??0000000000001C??4000000000??????4000000000????000000000000????000000000000??????00000000000050E5??6404??00009C6D0000000000009C6D4000000000??????????????0000DC??000000000000DC??00000000000004??00000000000051E5??64??000000000000000000000000000000000000000000000000000000000000000000000000000000000000????000000000000????6C69????????????2D????????78??78??362D????????6F2E32??04??000010??000001??0000474E5500000000????0000????0000????000000000000????0000??????000001??000006000000000000????000020??0000??????00007D??5A580000000000000000000000000000000000000000000000000000000015????????00000000000000000000??????00000000000082????????00000000000000000000????????????0000????????????00000000000000000000????????????0000??????000012??0000000000000000000062??0000000000006A??000012??000000000000000000001B??0000000000007E??000012??000000000000000000008B??0000000000004902??????00000000000000000000????????????0000????????????00000000000000000000????????00000000??????000012??000000000000000000008E??000000000000F401??????00000000000000000000????????????0000????????????00000000000000000000????000000000000????01??????00000000000000000000????????????0000????0000????000000000000000000000000000000000000????0000????000000000000000000000000000000000000??????000012??0000000000000000000025????????0000????????????00000000000000000000????000000000000????0000????00000000000000000000????000000000000????01??????00000000000000000000????????????0000????0000????00000000000000000000????000000000000????02??????00000000000000000000????????????0000????01??????00000000000000000000??????0000000000006602??????00000000000000000000????????????0000??????000012??0000000000000000000025????????0000????01??????00000000000000000000????000000000000????????????00000000000000000000????000000000000????01??????00000000000000000000????000000000000????0000????00000000000000000000????01??00000000????????????00000000000000000000????????????0000????????????00000000000000000000??????000000000000EC01??????00000000000000000000??????0000000000004B01??????00000000000000000000????????????0000??????000012??0000000000000000000025????????0000????01??????00000000000000000000????????????0000??????000012??0000000000000000000008??0000000000004302??????00000000000000000000????????????0000??????????????000000000000000000000A??0000000000003F01??????00000000000000000000????????????0000??????000012??00000000000000000000F0????00000000????01??????00000000000000000000??????????????00002F02??????00000000000000000000????01??00000000????????????00000000000000000000????000000000000??????????????0000000000000000000080????00000000????02??????00000000000000000000????000000000000??????000012??0000000000000000000074??000000000000BF????????00000000000000000000????????????0000????02??????00000000000000000000??????000000000000FA0000????00000000000000000000????????????0000??????000012??0000000000000000000011??000000000000A8??000012??0000000000000000000044000000000000??????000012??000000000000000000005A000000000000??????000012??0000000000000000000029??000000000000C6????????00000000000000000000????000000000000????????????00000000000000000000????000000000000????0000????00000000000000000000????????00000000????????????00000000000000000000??????000000000000BC????????00000000000000000000????02??00000000????01??????00000000000000000000??????00000000000034??000012??00000000000000000000A1????????0000????????????00000000000000000000????????????0000??????????????000000000000000000004B000000000000????0000????00000000000000000000????000000000000??????000012??0000000000000000000005????????0000??????000012??0000000000000000000031??00000000000074??000012??00000000000000000000FF??0000000000005E02??????00000000000000000000????000000000000????????????00000000000000000000????????????0000??????000012??0000000000000000000025????????0000????02??????00000000000000000000??????000000000000DE??000012??000000000000000000007B??00000000000030??000012??0000000000000000000075??000000000000D9??000012??000000000000000000000E000000000000????????????00000000000000000000????000000000000????02??????00000000000000000000????????????0000????????????00000000000000000000????????????0000????????????00000000000000000000????000000000000????02??????00000000000000000000????000000000000????01??????00000000000000000000????????????0000????????????00000000000000000000????000000000000????????????00000000000000000000??????0000000000005201??????0000????174000000000????00000000000000005F5F676D6F6E5F73??6172??5F5F??????76??52656769????????????6173??6573??6C69????????????61642E????2E30??72??63????72??6D??????68????????5F63????6174????????6E6474????????75??65??????69??????????????6E6F5F6C6F63????69????????????6B????74??72??6164??73??676D6173????????6E6E6563??????74??72??6164??73??6C66??????63????74??70??68????????5F6465????63????6663????6C????????63??73??2E????????63????74??73??72??70????????69????????????????????616E64??????6574??6174??6E??????74??77??69??????????????6469????????????5F6E74??61??????74??72??69??????????????70??????????6D6F6E????????74??6E??????6C6563??????6B????????72??616C6C6F63??676574??69??????????????73??72??6F6B????63????77????????70??6173??72??3634??73??67656D70??79??6574??6D656D73??74??72??6469??????????????????6565??????68????????6173??74??6D65??????74??6F63????70????????616E74??74??6475??32??73??67616464????74??69????????????6472??6663??????65??????74??6F63????70????????6C6C6F63??73??72??6174??72??616C70??74????????6D6F76????????656E6469????????????6C??????74??6F73??62????616D65??????6563??????????72??74????????656164??????6C6F63????74??6C6F63????74??6D65??????616E6469????????????616464??????????????6565????73??74??69????????????????????6D6D6F76????????70??6E3634??5F5F6C69????????????72??5F6D6169????????????73??73??70??69????????????65????????78??74??74??34??474C4942435F32??32??35????????42435F32??33??000002??02??02??03??02??02??02??03??03??02??02??02??0000000002??02??02??02??02??03??02??02??02??02??02??02??02??02??03??02??02??02??04??02??02??03??02??03??02??02??02??03??02??02??02??02??02??03??02??02??02??02??02??02??03??02??02??03??02??02??02??03??02??03??02??03??02??02??02??02??02??02??03??03??03??02??02??02??02??02??000001??01??24??000010??000020??000075??69??????????9602??00000000????????????????????000000000000????69????????????A2????????0000??????69??????????9602??00000000????81????????????060000????????????000000000000????81????????????070000????00000000000000000000????81????????????070000????00000000000000000000????81????????????070000????00000000000000000000000082??????0000????0000??????0000000000000000000008??????????0000070000????????????000000000000????82??????0000????0000????00000000000000000000????82??????0000????0000????00000000000000000000????82??????0000????0000????00000000000000000000????82??????0000????0000????00000000000000000000????82??????0000????0000????00000000000000000000????82??????0000????0000????00000000000000000000??????6000000000????0000??????000000000000000000004882??????0000????0000????00000000000000000000??????6000000000????0000????00000000000000000000??????6000000000????0000????00000000000000000000??????6000000000????0000????00000000000000000000??????6000000000????0000????00000000000000000000??????6000000000????0000?????? }
    
    condition:

        uint16(0) == 0x457f and 
        filesize < 100KB and 
        all of them
}

rule pwnlnx_backdoor_variant_2 {

    meta:
    
        description = "Rule to detect the backdoor pwnlnx variant 2"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "08cc67002782cbafd97a4bff549d25dd72d6976d2fdf79339aaf5a3ff7c3107e"
    
    strings:
        
        /*

        7F454C4602010103000000000000000002003E000100000000044000000000004000000000000000888C0D000000000000000000400038000500400021001E0001000000050000000000000000000000000040000000000000004000000000007E750D00000000007E750D00000000000000200000000000010000000600000080750D000000000080756D000000000080756D0000000000F012000000000000B09000000000000000002000000000000400000004000000580100000000000058014000000000005801400000000000440000000000000044000000000000000400000000000000070000000400000080750D000000000080756D000000000080756D000000000028000000000000007000000000000000080000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001000000001000000474E550000000000020000000600000012000000040000001400000003000000474E550005E7FAD31BCC78E6781883BB297455DC9ECB371F0000000080766D00000000002500000000000000F07E46000000000088766D00000000002500000000000000506742000000000090766D00000000002500000000000000B0A442000000000098766D00000000002500000000000000903F490000000000A0766D00000000002500000000000000909A420000000000A8766D0000000000250000000000000070D5420000000000B0766D000000000025000000000000007074420000000000B8766D000000000025000000000000009085420000000000C0766D00000000002500000000000000108B460000000000C8766D00000000002500000000000000608B420000000000D0766D000000000025000000000000003044420000000000D8766D00000000002500000000000000503F490000000000E0766D00000000002500000000000000508B460000000000E8766D00000000002500000000000000D0424200000000004883EC08E833010000E8D2010000E83D6A0A004883C408C3FF2572732D006800000000E900000000FF256A732D006800000000E900000000FF2562732D006800000000E900000000FF255A732D006800000000E900000000FF2552732D006800000000E900000000FF254A732D006800000000E900000000FF2542732D006800000000E900000000FF253A732D006800000000E900000000FF2532732D006800000000E900000000FF252A732D006800000000E900000000FF2522732D006800000000E900000000FF251A732D006800000000E900000000FF2512732D006800000000E900000000FF250A732D006800000000E90000000000000000000000000000000000000000000000000000000031ED4989D15E4889E24883E4F0505449C7C08016410048C7C1C016410048C7C7532F4000E827090100F490904883EC08488B0529722D004885C07402FFD04883C408C390909090909090909090909090554889E5534883EC08803D20842D0000755FBBD0756D00488B051A842D004881EBC0756D0048C1FB034883EB014839D87324660F1F4400004883C001488905F5832D00FF14C5C0756D00488B05E7832D004839D872E2B8E0614A004885C0740ABF98334C00E8265D0A00C605BF832D00014883C4085BC9C30F1F84000000000055B8C0474A004885C04889E5740FBEA0886D00BF98334C00E8D3420A0048833DE3702D00007419B8000000004885C0740FBFD8756D00C9FFE00F1F8000000000C9C39090554889E5534881ECF820000089BD2CDFFFFF48C745C8000000008B45143D001000000F871B0200008B451489C2488D8DC0EFFFFF8B852CDFFFFF4889CE89C7E88F43000085C00F84FA0100008B451489C2488D85C0EFFFFF89D64889C7E8CA030000BA908B4A00488D85C0EFFFFF4889D64889C7E8D3450100488945C848837DC8000F84C1010000488D85C0EFFFFF488D9530DFFFFF4889D64889C7E83B21030085C00F857C010000488B8560DFFFFF488945E0C7451400000000488B45E0894524488B45E048C1F820894520488B451048890424488B45184889442408488B45204889442410E80D550000894510BE18000000488D7D10E82F030000488D4D108B852CDFFFFFBA180000004889CE89C7E80745000085C00F840A010000488D4D108B852CDFFFFFBA180000004889CE89C7E89C42000085C00F84EC000000BE18000000488D7D10E8DF0200008B5D10488B451048890424488B45184889442408488B45204889442410E88A54000039C30F85B70000008B452089C04889C248C1E2208B452489C0488D0402488945E8488B4DE8488B45C8BA000000004889CE4889C7E8D4620100488B45E8488945D8EB67488B55C8488D85C0DFFFFF4889D1BA00100000BE010000004889C7E86A4501008945D4837DD4007E568B55D4488D85C0DFFFFF89D64889C7E83D0200008B45D44863D0488D8DC0DFFFFF8B852CDFFFFF4889CE89C7E81144000085C074248B45D44898480145D8488B45D8483B45E07C8FEB1090EB0D90EB0A90EB0790EB0490EB0190488B45C84889C7E83B3D0100EB0790EB0490EB0190B8000000004881C4F82000005BC9C3554889E5534881ECF80100004889BD28FEFFFFE89B8000004889C7E8A37C0000C745E0FFFFFFFF488B8528FEFFFF8B40088945E4488B8528FEFFFF8B008945E8488B8528FEFFFF8B40048945EC8B4DEC8B45E8BA0A00000089CE89C7E85B3C00008945E0837DE0FF0F843E010000488D45C0BA18000000BE000000004889C7E8A7FBFFFFC745CC00000000C745C4860100008B45E48945C8488B45C048890424488B45C84889442408488B45D04889442410E8E95200008945C0488D45C0BE180000004889C7E808010000488D4DC08B45E0BA180000004889CE89C7E8E342000085C00F84C6000000488D8530FEFFFF4889C7E81B180300488D8530FEFFFFBE860100004889C7E8C7000000488D8D30FEFFFF8B45E0BA860100004889CE89C7E89F42000085C00F8485000000488D4DC08B45E0BA180000004889CE89C7E83740000085C0746E488D45C0BE180000004889C7E87B0000008B5DC0488B45C048890424488B45C84889442408488B45D04889442410E82652000039C3753A8B45CC83F80375338B45E0488B55C048891424488B55C84889542408488B55D0488954241089C7E8FDFBFFFFEB0D90EB0A90EB0790EB0490EB01908B45E089C7E860DE0000B8000000004881C4F80100005BC9C390554889E548897DE88975E4C745FC10000000488B45E8488945F0C745F800000000EB30488B45F00FB6088B45F889C2C1FA1FF77DFC89D048980FB68010776D0089CA31C2488B45F088108345F801488345F0018B45F83B45E47CC8488B45E8C9C3554889E548897DE88975E4488B45E8488945F0C745FC00000000EB1F488B45F00FB6100FB605456D2D0031C2488B45F088108345FC01488345F0018B45FC3B45E47CD9488B45E8C9C39090554889E5534881EC0841000089BD1CBFFFFF48C745B80000000048C745C00000000048C745C8000000008B451489C2488D8DB0EFFFFF8B851CBFFFFF4889CE89C7E8B53E000085C00F845B0300008B451489C2488D85B0EFFFFF89D64889C7E8F0FEFFFF488D85B0EFFFFF488D95B0DFFFFF4889D64889C7E8372E0100BA988B4A00488D8DB0DFFFFF488D85B0CFFFFFBE001000004889C7B800000000E892340100488D85B0CFFFFF4889C7E8F36802004883C0014889C7E8670A0200488945B848837DB8000F84E0020000488D95B0CFFFFF488B45B84889D64889C7E84AF8FFFF488D85B0DFFFFF488D5DB0B9D01F4300BA000000004889DE4889C7E8B21203008945D4837DD4000F8E8C020000C745D800000000E969010000488B45B08B55D84863D248C1E2034801D0488B00488D5813BADB8B4A00488D8DB0DFFFFF488D85B0BFFFFF4989D8BE001000004889C7B800000000E8D9330100488D85B0BFFFFF488D9520BFFFFF4889D64889C7E8901B030085C00F850401000048C745C020776D0048C745C820776D00488D8520BFFFFF4883C0584889C7E815E202004889C7E81DE00200488B8D50BFFFFF8B9538BFFFFF4189D04181E0FF0100008B9538BFFFFF89D781E700F00000488B55B08B5DD84863DB48C1E3034801DA488B12488D7213BAE88B4A00488D9DB0CFFFFF488944241848894C2410488B45C84889442408488B45C0488904244589C14189F84889F1BE001000004889DF

        */
        
        $bp = { 7F??4C4602??01??000000000000000002??3E????0000000004??00000000??????00000000000088????????????00000000??????38??05????????????????0000????????????0000000000000000??????0000000000004000000000??????0D??????????????0D????????0000????00000000????0000????0000????????????0000????????????0000????????????0000????12??00000000????????????00000000????00000000??????000004??00005801??00000000??????4000000000??????4000000000????????00000000????????00000000??????000000000000070000??????000080??????0000000080??????0000000080??????0000000028??00000000000070??00000000000008??00000000000051E5??64??000000000000000000000000000000000000000000000000000000000000000000000000000000000000????000000000000??????000010??000001??0000474E5500000000????0000????0000????0000??????000014??000003??0000474E55????????????CC78??78??83????????????CB371F0000000080??????0000000025????????0000????7E??00000000????????????0000????????????0000??????4200000000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000????????????0000??????4200000000????????????0000????????????0000??????4200000000????????????0000????????????0000????????????0000????76??00000000????????????0000????8B????00000000C8??????0000000025????????0000??????4200000000????76??00000000????????????0000????444200000000????76??00000000????????????0000??????4900000000????76??00000000????????????0000??????4600000000????76??00000000????????????0000????424200000000??????EC08??33??0000E8????????E8????????4883????C3FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????00000000000000000000000000000000000000000000000031??4989??5E4889??4883????505449C7??????????48C7??????????48C7??????????E8????????F490904883????488B??????????4885??74??FF??4883????C390909090909090909090909090554889??534883????80????????????75??BB????????488B??????????4881??????????48C1????4883????4839??73??660F1F??????4883????4889??????????FF????????????488B??????????4839??72??B8????????4885??74??BF????????E8????????C6????????????4883????5BC9C30F1F????????????55B8????????4885??4889??74??BE????????BF????????E8????????4883????????????74??B8????????4885??74??BF????????C9FF??0F1F??????????C9C39090554889??534881??????????89??????????48C7????????????8B????3D????????0F87????????8B????89??488D??????????8B??????????4889??89??E8????????85??0F84????????8B????89??488D??????????89??4889??E8????????BA????????488D??????????4889??4889??E8????????4889????4883??????0F84????????488D??????????488D??????????4889??4889??E8????????85??0F85????????488B??????????4889????C7????????????488B????89????488B????48C1????89????488B????4889????488B????4889??????488B????4889??????E8????????89????BE????????488D????E8????????488D????8B??????????BA????????4889??89??E8????????85??0F84????????488D????8B??????????BA????????4889??89??E8????????85??0F84????????BE????????488D????E8????????8B????488B????4889????488B????4889??????488B????4889??????E8????????39??0F85????????8B????89??4889??48C1????8B????89??488D????4889????488B????488B????BA????????4889??4889??E8????????488B????4889????EB??488B????488D??????????4889??BA????????BE????????4889??E8????????89????83??????7E??8B????488D??????????89??4889??E8????????8B????4863??488D??????????8B??????????4889??89??E8????????85??74??8B????48984801????488B????483B????7C??EB??90EB??90EB??90EB??90EB??90EB??90488B????4889??E8????????EB??90EB??90EB??90B8????????4881??????????5BC9C3554889??534881??????????4889??????????E8????????4889??E8????????C7????????????488B??????????8B????89????488B??????????8B??89????488B??????????8B????89????8B????8B????BA????????89??89??E8????????89????83??????0F84????????488D????BA????????BE????????4889??E8????????C7????????????C7????????????8B????89????488B????4889????488B????4889??????488B????4889??????E8????????89????488D????BE????????4889??E8????????488D????8B????BA????????4889??89??E8????????85??0F84????????488D??????????4889??E8????????488D??????????BE????????4889??E8????????488D??????????8B????BA????????4889??89??E8????????85??0F84????????488D????8B????BA????????4889??89??E8????????85??74??488D????BE????????4889??E8????????8B????488B????4889????488B????4889??????488B????4889??????E8????????39??75??8B????83????75??8B????488B????4889????488B????4889??????488B????4889??????89??E8????????EB??90EB??90EB??90EB??90EB??908B????89??E8????????B8????????4881??????????5BC9C390554889??4889????89????C7????????????488B????4889????C7????????????EB??488B????0FB6??8B????89??C1????F7????89??48980FB6??????????89??31??488B????88??83??????4883??????8B????3B????7C??488B????C9C3554889??4889????89????488B????4889????C7????????????EB??488B????0FB6??0FB6??????????31??488B????88??83??????4883??????8B????3B????7C??488B????C9C39090554889??534881??????????89??????????48C7????????????48C7????????????48C7????????????8B????89??488D??????????8B??????????4889??89??E8????????85??0F84????????8B????89??488D??????????89??4889??E8????????488D??????????488D??????????4889??4889??E8????????BA????????488D??????????488D??????????BE????????4889??B8????????E8????????488D??????????4889??E8????????4883????4889??E8????????4889????4883??????0F84????????488D??????????488B????4889??4889??E8????????488D??????????488D????B9????????BA????????4889??4889??E8????????89????83??????0F8E????????C7????????????E9????????488B????8B????4863??48C1????4801??488B??488D????BA????????488D??????????488D??????????4989??BE????????4889??B8????????E8????????488D??????????488D??????????4889??4889??E8????????85??0F85????????48C7????????????48C7????????????488D??????????4883????4889??E8????????4889??E8????????488B??????????8B??????????4189??4181??????????8B??????????89??81??????????488B????8B????4863??48C1????4801??488B??488D????BA????????488D??????????4889??????4889??????488B????4889??????488B????4889????4589??4189??4889??BE????????4889?? }

    condition:

        uint16(0) == 0x457f and 
        filesize < 1000KB and 
        all of them
}

rule pwnlnx_backdoor_variant_3 {

    meta:
    
        description = "Rule to detect the backdoor pwnlnx variant"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "08f29e234f0ce3bded1771d702f8b5963b144141727e48b8a0594f58317aac75"
    
    strings:

        /*

        7F454C4602010103000000000000000002003E000100000000044000000000004000000000000000B0BA3A0000000000000000004000380005004000270024000100000005000000000000000000000000004000000000000000400000000000BAA40C0000000000BAA40C000000000000002000000000000100000006000000C0A40C0000000000C0A46C0000000000C0A46C000000000050130000000000008890000000000000000020000000000004000000040000005801000000000000580140000000000058014000000000002000000000000000200000000000000004000000000000000700000004000000C0A40C0000000000C0A46C0000000000C0A46C000000000028000000000000007800000000000000080000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001000000001000000474E550000000000020000000400000000000000C0A56C00000000002500000000000000E084420000000000C8A56C00000000002500000000000000D037420000000000D0A56C000000000025000000000000008073420000000000D8A56C0000000000250000000000000050DA420000000000E0A56C00000000002500000000000000F024480000000000E8A56C00000000002500000000000000A084420000000000F0A56C00000000002500000000000000F083430000000000F8A56C00000000002500000000000000305E42000000000000A66C00000000002500000000000000506F42000000000008A66C00000000002500000000000000109142000000000010A66C00000000002500000000000000707542000000000018A66C00000000002500000000000000B01442000000000020A66C00000000002500000000000000B02448000000000028A66C00000000002500000000000000509142000000000030A66C0000000000250000000000000050134200000000004883EC08E843010000E862020000E84D9409004883C408C3FF25C2A22C006800000000E900000000FF25BAA22C006800000000E900000000FF25B2A22C006800000000E900000000FF25AAA22C006800000000E900000000FF25A2A22C006800000000E900000000FF259AA22C006800000000E900000000FF2592A22C006800000000E900000000FF258AA22C006800000000E900000000FF2582A22C006800000000E900000000FF257AA22C006800000000E900000000FF2572A22C006800000000E900000000FF256AA22C006800000000E900000000FF2562A22C006800000000E900000000FF255AA22C006800000000E900000000FF2552A22C006800000000E90000000000000000000000000000000000000000000000000000000031ED4989D15E4889E24883E4F0505449C7C0C0BC400048C7C100BD400048C7C7D02E4000E8A7B20000F490904883EC08488B0569A12C004885C07402FFD04883C408C390909090909090909090909090B817B86C0055482D10B86C004883F80E4889E5761BB8000000004885C074115DBF10B86C00FFE0660F1F8400000000005DC366666666662E0F1F840000000000BE10B86C00554881EE10B86C0048C1FE034889E54889F048C1E83F4801C648D1FE7415B8000000004885C0740B5DBF10B86C00FFE00F1F005DC3660F1F440000803D69B32C00007573554889E553BB10A56C004881EB00A56C004883EC08488B0553B32C0048C1FB034883EB014839D87324660F1F4400004883C00148890535B32C00FF14C500A56C00488B0527B32C004839D872E2E825FFFFFFB8708E49004885C0740ABFB8904B00E831890900C605FAB22C00014883C4085B5DF3C3669055B8508B49004885C04889E5740FBE60B86C00BFB8904B00E8E3850900BF18A56C0048833F0075085DE912FFFFFF6690B8000000004885C074EEFFD0EBEA9090554889E5534881ECD820000089BD2CDFFFFF48C745E0000000008B45143D001000007605E9F50100008B451489C2488D8DC0EFFFFF8B852CDFFFFF4889CE89C7E8C941000085C07505E9D00100008B451489C2488D85C0EFFFFF89D64889C7E870030000488D85C0EFFFFFBE24A549004889C7E828320100488945E048837DE0007505E996010000488D9530DFFFFF488D85C0EFFFFF4889D64889C7E82FCD030085C07405E968010000488B8560DFFFFF488945D8C7451400000000488B45D8894524488B45D848C1F8208945204883EC08FF7520FF7518FF7510E8585200004883C420894510BE18000000488D7D10E8DF0200008B852CDFFFFFBA18000000488D751089C7E82843000085C07505E9FE0000008B852CDFFFFFBA18000000488D751089C7E8E440000085C07505E9DF000000BE18000000488D7D10E8930200008B5D104883EC08FF7520FF7518FF7510E8E25100004883C42039C37405E9AF0000008B452089C048C1E0204889C28B452489C04801D0488945D0488B4DD0488B45E0BA000000004889CE4889C7E8AD4A0100488B45D0488945E8EB6B488B55E0488D85C0DFFFFF4889D1BA00100000BE010000004889C7E8F33001008945CC837DCC007F02EB4A8B55CC488D85C0DFFFFF89D64889C7E8F80100008B45CC4863D0488D8DC0DFFFFF8B852CDFFFFF4889CE89C7E83A42000085C07502EB138B45CC4898480145E8488B45E8483B45D87C8B488B45E04889C7E842270100B800000000488B5DF8C9C3554889E5534881ECD80100004889BD28FEFFFFE8BF7F00004889C7E8677F0000C745ECFFFFFFFF488B8528FEFFFF8B40088945E8488B8528FEFFFF8B008945E4488B8528FEFFFF8B40048945E08B4DE08B45E4BA0A00000089CE89C7E8063B00008945EC837DECFF7505E927010000488D45C0BA18000000BE000000004889C7E85AFBFFFFC745CC00000000C745C4860100008B45E88945C84883EC08FF75D0FF75C8FF75C0E8645000004883C4208945C0488D45C0BE180000004889C7E8E8000000488D4DC08B45ECBA180000004889CE89C7E83141000085C07505E9B4000000488D8530FEFFFF4889C7E8F6BD0300488D8530FEFFFFBE860100004889C7E8A6000000488D8D30FEFFFF8B45ECBA860100004889CE89C7E8EC40000085C07502EB72488D4DC08B45ECBA180000004889CE89C7E8AB3E000085C07502EB56488D45C0BE180000004889C7E85A0000008B5DC04883EC08FF75D0FF75C8FF75C0E8A94F00004883C42039C37402EB268B45CC83F8037402EB1C8B45EC4883EC08FF75D0FF75C8FF75C089C7E846FCFFFF4883C420908B45EC89C7E8C79A0000B800000000488B5DF8C9C3554889E548897DE88975E4C745F010000000488B45E8488945F8C745F400000000EB2C488B45F80FB6088B45F499F77DF089D048980FB68050A66C0031C189CA488B45F888108345F401488345F8018B45F43B45E47CCC488B45E85DC3554889E548897DE88975E4488B45E8488945F8C745F400000000EB1F488B45F80FB6100FB605659C2C0031C2488B45F888108345F401488345F8018B45F43B45E47CD9488B45E85DC39090554889E5534881ECD840000089BD2CBFFFFF48C745E80000000048C745D80000000048C745D0000000008B451489C2488D8DC0EFFFFF8B852CBFFFFF4889CE89C7E84C3D000085C07505E9400300008B451489C2488D85C0EFFFFF89D64889C7E8F3FEFFFF488D95C0DFFFFF488D85C0EFFFFF4889D64889C7E896180100488D95C0DFFFFF488D85C0CFFFFF4889D1BA28A54900BE001000004889C7B800000000E86E1F0100488D85C0CFFFFF4889C7E83F3A02004883C0014889C7E863E80100488945E848837DE8007505E9BE020000488D95C0CFFFFF488B45E84889D64889C7E815F8FFFF488D75C0488D85C0DFFFFFB980C44300BA000000004889C7E830B703008945CC837DCC000F8E72020000C745E400000000E95A010000488B45C08B55E44863D248C1E2034801D0488B00488D4813488D95C0DFFFFF488D85C0BFFFFF4989C84889D1BA6BA54900BE001000004889C7B800000000E8B41E0100488D9530BFFFFF488D85C0BFFFFF4889D64889C7E8DBC7030085C00F85F200000048C745D860A66C0048C745D060A66C00488D8530BFFFFF4883C0584889C7E8C08C03004889C7E8988C03004989C0488B9560BFFFFF8B8548BFFFFF25FF01000089C78B8548BFFFFF2500F0000089C6488B45C08B4DE44863C948C1E1034801C8488B00488D4813488D85C0CFFFFF415052FF75D0FF75D84189F94189F0BA78A54900BE001000004889C7B800000000E8FF1D01004883C420488B45E84889C7E8CF3802004889C3488D85C0CFFFFF

        */

        $bp = { 7F??4C4602??01??000000000000000002??3E????0000000004??00000000??????000000000000B0??3A??000000000000000040??????????????????????01??000005????????0000000000000000??????0000000000004000000000????????????0000????????????00000000????00000000????0000????0000????A40C??00000000C0??????????????C0??????????????5013??00000000????????????00000000????00000000??????000004??00005801??00000000??????4000000000??????4000000000????000000000000????000000000000??????000000000000070000??????0000C0??????????????C0??????????????C0??????????????28??00000000000078??00000000000008??00000000000051E5??64??000000000000000000000000000000000000000000000000000000000000000000000000000000000000????000000000000??????000010??000001??0000474E5500000000????0000??????000000000000C0????????????????????????0000????84????00000000C8??????0000000025????????0000????374200000000????A56C00000000????????????0000????????????0000????A56C00000000????????????0000??????4200000000????A56C00000000????????????0000????24??00000000????A56C00000000????????????0000????????????0000????A56C00000000????????????0000????83??????0000????A56C00000000????????????0000????5E42000000000000A66C00000000????????????0000??????4200000000????A66C00000000????????????0000????914200000000????A66C00000000????????????0000??????4200000000????A66C00000000????????????0000????????????0000????A66C00000000????????????0000????????????0000????A66C00000000????????????0000??????4200000000????A66C00000000????????????0000??????4200000000??????EC08??4301??????62??0000E8????????4883????C3FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????00000000000000000000000000000000000000000000000031??4989??5E4889??4883????505449C7??????????48C7??????????48C7??????????E8????????F490904883????488B??????????4885??74??FF??4883????C390909090909090909090909090B8????????55482D????????4883????4889??76??B8????????4885??74??5DBF????????FF??660F1F????????????5DC366666666????????????????????BE????????554881??????????48C1????4889??4889??48C1????4801??48D1??74??B8????????4885??74??5DBF????????FF??0F1F??5DC3660F1F??????80????????????75??554889??53BB????????4881??????????4883????488B??????????48C1????4883????4839??73??660F1F??????4883????4889??????????FF????????????488B??????????4839??72??E8????????B8????????4885??74??BF????????E8????????C6????????????4883????5B5DF3??669055B8????????4885??4889??74??BE????????BF????????E8????????BF????????4883????75??5DE9????????6690B8????????4885??74??FF??EB??9090554889??534881??????????89??????????48C7????????????8B????3D????????76??E9????????8B????89??488D??????????8B??????????4889??89??E8????????85??75??E9????????8B????89??488D??????????89??4889??E8????????488D??????????BE????????4889??E8????????4889????4883??????75??E9????????488D??????????488D??????????4889??4889??E8????????85??74??E9????????488B??????????4889????C7????????????488B????89????488B????48C1????89????4883????FF????FF????FF????E8????????4883????89????BE????????488D????E8????????8B??????????BA????????488D????89??E8????????85??75??E9????????8B??????????BA????????488D????89??E8????????85??75??E9????????BE????????488D????E8????????8B????4883????FF????FF????FF????E8????????4883????39??74??E9????????8B????89??48C1????4889??8B????89??4801??4889????488B????488B????BA????????4889??4889??E8????????488B????4889????EB??488B????488D??????????4889??BA????????BE????????4889??E8????????89????83??????7F??EB??8B????488D??????????89??4889??E8????????8B????4863??488D??????????8B??????????4889??89??E8????????85??75??EB??8B????48984801????488B????483B????7C??488B????4889??E8????????B8????????488B????C9C3554889??534881??????????4889??????????E8????????4889??E8????????C7????????????488B??????????8B????89????488B??????????8B??89????488B??????????8B????89????8B????8B????BA????????89??89??E8????????89????83??????75??E9????????488D????BA????????BE????????4889??E8????????C7????????????C7????????????8B????89????4883????FF????FF????FF????E8????????4883????89????488D????BE????????4889??E8????????488D????8B????BA????????4889??89??E8????????85??75??E9????????488D??????????4889??E8????????488D??????????BE????????4889??E8????????488D??????????8B????BA????????4889??89??E8????????85??75??EB??488D????8B????BA????????4889??89??E8????????85??75??EB??488D????BE????????4889??E8????????8B????4883????FF????FF????FF????E8????????4883????39??74??EB??8B????83????74??EB??8B????4883????FF????FF????FF????89??E8????????4883????908B????89??E8????????B8????????488B????C9C3554889??4889????89????C7????????????488B????4889????C7????????????EB??488B????0FB6??8B????99F7????89??48980FB6??????????31??89??488B????88??83??????4883??????8B????3B????7C??488B????5DC3554889??4889????89????488B????4889????C7????????????EB??488B????0FB6??0FB6??????????31??488B????88??83??????4883??????8B????3B????7C??488B????5DC39090554889??534881??????????89??????????48C7????????????48C7????????????48C7????????????8B????89??488D??????????8B??????????4889??89??E8????????85??75??E9????????8B????89??488D??????????89??4889??E8????????488D??????????488D??????????4889??4889??E8????????488D??????????488D??????????4889??BA????????BE????????4889??B8????????E8????????488D??????????4889??E8????????4883????4889??E8????????4889????4883??????75??E9????????488D??????????488B????4889??4889??E8????????488D????488D??????????B9????????BA????????4889??E8????????89????83??????0F8E????????C7????????????E9????????488B????8B????4863??48C1????4801??488B??488D????488D??????????488D??????????4989??4889??BA????????BE????????4889??B8????????E8????????488D??????????488D??????????4889??4889??E8????????85??0F85????????48C7????????????48C7????????????488D??????????4883????4889??E8????????4889??E8????????4989??488B??????????8B??????????25????????89??8B??????????25????????89??488B????8B????4863??48C1????4801??488B??488D????488D??????????415052FF????FF????4189??4189??BA????????BE????????4889??B8????????E8????????4883????488B????4889??E8????????4889??488D?????????? }

        condition:

            uint16(0) == 0x457f and 
            filesize < 4000KB and 
            all of them
}

rule pwnlnx_backdoor_variant_4 {

    meta:
    
        description = "Rule to detect the backdoor pwnlnx variant 4"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "2590ab56d46ff344f2aa4998efd1db216850bdddfc146d5d37e4b7d07c7336fc"
    
    strings:

        /*

        7F454C4602010100000000000000000001003E000100000000000000000000000000000000000000A82803000000000000000000400000000000400031002E00040000001400000003000000474E5500089FECFBE5E7F9736AEBF52A0D3FF3394571C0BD000000000000000000000000554889E553E800000000FF1425000000004889C74889C34881E7FFFFFEFFFF1425000000004889D85BC9C30F1F440000554889E5E800000000FF142500000000C9C366666666662E0F1F840000000000554889E5E8000000004885FF74524C8B47184D85C0744965488B0425000000008B80A80400004889150000000048C7C20000000089C1C1F91FC1E91601C825FF03000029C848984C8904C500000000FF1500000000C9C3660F1F84000000000031C0C9C36666662E0F1F840000000000554889E5E8000000004889150000000048C7C200000000FF1500000000C9C390554889E5E8000000008B96C0000000488B8ED0000000488D14110FB642093C06400F94C73C11410F94C174144084FF750FB801000000C9C30F1F8400000000008B050000000039420C74253B421074204584C9742B8B86BC0000004801C10FB705000000006639017406663B410275C14889F741FFD0B802000000C9C30F1F004084FF74AC8B86BC0000004801C10FB7050000000066390175D0EBD40F1F4000554889E5534883EC08E80000000031D24889F331F6E800000000483D00F0FFFF772F4885DB7417488B5018488B5210488B52E8488B525848899AF800000031F64889C7E80000000031C04883C4085BC9C383C8FFEBF4662E0F1F840000000000554889E5415453E8000000004989F44889D331F631D2E800000000483D00F0FFFF7733488B501831F64889C7488B5210488B52E8488B5258488B8AF800000049890C2448899AF8000000E80000000031C05B415CC9C383C8FFEBF60F1F440000554889E5534883EC08E80000000031D24889F331F6E800000000483D00F0FFFF772F4885DB7417488B5018488B5210488B52E8488B525848899A0001000031F64889C7E80000000031C04883C4085BC9C383C8FFEBF4662E0F1F840000000000554889E5415453E8000000004989F44889D331F631D2E800000000483D00F0FFFF7733488B501831F64889C7488B5210488B52E8488B5258488B8A0001000049890C2448899A00010000E80000000031C05B415CC9C383C8FFEBF60F1F440000554889E5534883EC08E80000000031D24889F3BE00000100E800000000483D00F0FFFF77204885DB7408488B502048895A3031F64889C7E80000000031C04883C4085BC9C383C8FFEBF4660F1F440000554889E5415453E8000000004989F44889D3BE0000010031D2E800000000483D00F0FFFF7725488B502031F64889C7488B523049891424488B502048895A30E80000000031C05B415CC9C383C8FFEBF6554889E54157415641554154534883EC28E8000000004889F3488D75C84989FF4189D54889DFBA0A0000004989CC44894DB84D89C6E800000000488B1500000000448B4DB84881FA00000000488D4AF87517EB340F1F4000488B51084881FA00000000488D4AF8741F0FB752F84839D075E64883C42831C05B415C415D415E415FC9C30F1F4400004D89F04C89E14489EA4889DE4C89FFFF15000000004883C4285B415C415D415E415FC9C30F1F4000554889E54157415641554154534883EC38E80000000065488B04250000000048897DB848894DB04189D48B80A80400004889F3B90200000048C7C6000000004889DF4D89C54589CE89C2C1FA1FC1EA1601D025FF03000029D0F3A648984C8B3CC5000000000F84D5000000B90300000048C7C6000000004889DFF3A60F84BE00000031F64585E44889D848895DC8448965C47431418D5424FF31F6488D7C13010FB6084883C0014889CA48C1E10448C1EA044801CA4801F24839F8488D0C92488D344A75DB8975C0488D75C04C89FFE8000000004885C04889C10F84A1000000488B41104885C07446817854FFCB00F10F847A000000488B0500000000483D000000004C8D78F87517EB350F1F440000498B4708483D000000004C8D78F87420498B374889DFE80000000085C075E131C04883C4385B415C415D415E415FC9C34589F14D89E8488B4DB04489E24889DE488B7DB8FF15000000004883C4385B415C415D415E415FC9C30F1F8000000000817850852DB6950F8579FFFFFF31C0EBB0488D75C04C89FFE8000000004885C04889C1749A498B7F10488B87F8000000488B40084885C0748631D24889CE48894DA8FFD04885C0488B4DA80F841FFFFFFF31C0E969FFFFFF0F1F840000000000554889E5534883EC08E80000000089FA488B3D000000004881FF00000000488D5FF87425663957F8750CEB240F1F4000663950F8741A488B4308483D00000000488D58F84889C775E74883C4085BC9C3E8000000004889DFE8000000004883C4085BC9C36666662E0F1F840000000000554889E5534883EC08E80000000089FA488B3D000000004881FF00000000488D5FF87425663957F8750CEB240F1F4000663950F8741A488B4308483D00000000488D58F84889C775E74883C4085BC9C3E8000000004889DFE8000000004883C4085BC9C36666662E0F1F840000000000554889E5534883EC08E80000000089FA488B3D000000004881FF00000000488D5FF87425663957F8750CEB240F1F4000663950F8741A488B4308483D00000000488D58F84889C775E74883C4085BC9C3E8000000004889DFE8000000004883C4085BC9C36666662E0F1F840000000000554889E5534883EC08E80000000089FA488B3D000000004881FF00000000488D5FF87425663957F8750CEB240F1F4000663950F8741A488B4308483D00000000488D58F84889C775E74883C4085BC9C3E8000000004889DFE8000000004883C4085BC9C36666662E0F1F840000000000554889E5534883EC08E80000000089FA488B3D000000004881FF00000000488D5FF87425663957F8750CEB240F1F4000663950F8741A488B4308483D00000000488D58F84889C775E74883C4085BC9C3E8000000004889DFE8000000004883C4085BC9C36666662E0F1F840000000000554889E541554154534883EC08E8000000004C8B25000000004989FD4981FC00000000498D5C24F87518EB3D0F1F40004C8B63084981FC00000000498D5C24F87427488B334C89EFE80000000085C075DF4C89E7E800000000488B3BE8000000004889DFE8000000004883C4085B415C415DC9C36666662E0F1F840000000000554889E5534883EC08E800000000488B3500000000BAD000000089FBBF18000000E8000000004885C0741A668918488B1500000000488D780848C7C600000000E8000000004883C4085BC9C30F1F4000554889E5534883EC08E800000000488B3500000000BAD000000089FBBF18000000E8000000004885C0741A668918488B1500000000488D780848C7C600000000E8000000004883C4085BC9C30F1F4000554889E5534883EC08E800000000488B3500000000BAD000000089FBBF18000000E8000000004885C0741A668918488B1500000000488D780848C7C600000000E8000000004883C4085BC9C30F1F4000554889E5534883EC08E800000000488B3500000000BAD000000089FBBF18000000E8000000004885C0741A668918488B1500000000488D780848C7C600000000E8000000004883C4085BC9C30F1F4000554889E5

        */

        $bp = { 7F??4C4602??01??000000000000000001??3E????000000000000000000000000000000000000????????????000000000000??????0000000040??????????????000014??000003??0000474E55????9FECFBE5??F973??EB??2A??????????71??BD????????0000000000000000554889??53E8????????FF????????????4889??4889??4881??????????FF????????????4889??5BC9C30F1F??????554889??E8????????FF????????????C9C366666666????????????????????554889??E8????????4885??74??4C8B????4D85??74??65??8B????????????8B??????????4889??????????48C7??????????89??C1????C1????01??25????????29??48984C89????????????FF??????????C9C3660F1F????????????31??C9C36666662E????????????????554889??E8????????4889??????????48C7??????????FF??????????C9C390554889??E8????????8B??????????488B??????????488D????0FB6????3C??400F94??3C??410F94??74??4084??75??B8????????C9C30F1F????????????8B??????????39????74??3B????74??4584??74??8B??????????4801??0FB7??????????66????74??66??????75??4889??41FF??B8????????C9C30F1F??4084??74??8B??????????4801??0FB7??????????66????75??EB??0F1F????554889??534883????E8????????31??4889??31??E8????????483D????????77??4885??74??488B????488B????488B????488B????4889??????????31??4889??E8????????31??4883????5BC9C383????EB??662E0F1F????????????554889??415453E8????????4989??4889??31??31??E8????????483D????????77??488B????31??4889??488B????488B????488B????488B??????????4989????4889??????????E8????????31??5B415CC9C383????EB??0F1F??????554889??534883????E8????????31??4889??31??E8????????483D????????77??4885??74??488B????488B????488B????488B????4889??????????31??4889??E8????????31??4883????5BC9C383????EB??662E0F1F????????????554889??415453E8????????4989??4889??31??31??E8????????483D????????77??488B????31??4889??488B????488B????488B????488B??????????4989????4889??????????E8????????31??5B415CC9C383????EB??0F1F??????554889??534883????E8????????31??4889??BE????????E8????????483D????????77??4885??74??488B????4889????31??4889??E8????????31??4883????5BC9C383????EB??660F1F??????554889??415453E8????????4989??4889??BE????????31??E8????????483D????????77??488B????31??4889??488B????4989????488B????4889????E8????????31??5B415CC9C383????EB??554889??4157415641554154534883????E8????????4889??488D????4989??4189??4889??BA????????4989??4489????4D89??E8????????488B??????????448B????4881??????????488D????75??EB??0F1F????488B????4881??????????488D????74??0FB7????4839??75??4883????31??5B415C415D415E415FC9C30F1F??????4D89??4C89??4489??4889??4C89??FF??????????4883????5B415C415D415E415FC9C30F1F????554889??4157415641554154534883????E8????????65??8B????????????4889????4889????4189??8B??????????4889??B9????????48C7??????????4889??4D89??4589??89??C1????C1????01??25????????29??F3A648984C8B????????????0F84????????B9????????48C7??????????4889??F3A60F84????????31??4585??4889??4889????4489????74??418D??????31??488D??????0FB6??4883????4889??48C1????48C1????4801??4801??4839??488D????488D????75??89????488D????4C89??E8????????4885??4889??0F84????????488B????4885??74??81????????????0F84????????488B??????????483D????????4C8D????75??EB??0F1F??????498B????483D????????4C8D????74??498B??4889??E8????????85??75??31??4883????5B415C415D415E415FC9C34589??4D89??488B????4489??4889??488B????FF??????????4883????5B415C415D415E415FC9C30F1F??????????81????????????0F85????????31??EB??488D????4C89??E8????????4885??4889??74??498B????488B??????????488B????4885??74??31??4889??4889????FF??4885??488B????0F84????????31??E9????????0F1F????????????554889??534883????E8????????89??488B??????????4881??????????488D????74??66??????75??EB??0F1F????66??????74??488B????483D????????488D????4889??75??4883????5BC9C3E8????????4889??E8????????4883????5BC9C36666662E????????????????554889??534883????E8????????89??488B??????????4881??????????488D????74??66??????75??EB??0F1F????66??????74??488B????483D????????488D????4889??75??4883????5BC9C3E8????????4889??E8????????4883????5BC9C36666662E????????????????554889??534883????E8????????89??488B??????????4881??????????488D????74??66??????75??EB??0F1F????66??????74??488B????483D????????488D????4889??75??4883????5BC9C3E8????????4889??E8????????4883????5BC9C36666662E????????????????554889??534883????E8????????89??488B??????????4881??????????488D????74??66??????75??EB??0F1F????66??????74??488B????483D????????488D????4889??75??4883????5BC9C3E8????????4889??E8????????4883????5BC9C36666662E????????????????554889??534883????E8????????89??488B??????????4881??????????488D????74??66??????75??EB??0F1F????66??????74??488B????483D????????488D????4889??75??4883????5BC9C3E8????????4889??E8????????4883????5BC9C36666662E????????????????554889??41554154534883????E8????????4C8B??????????4989??4981??????????498D??????75??EB??0F1F????4C8B????4981??????????498D??????74??488B??4C89??E8????????85??75??4C89??E8????????488B??E8????????4889??E8????????4883????5B415C415DC9C36666662E????????????????554889??534883????E8????????488B??????????BA????????89??BF????????E8????????4885??74??66????488B??????????488D????48C7??????????E8????????4883????5BC9C30F1F????554889??534883????E8????????488B??????????BA????????89??BF????????E8????????4885??74??66????488B??????????488D????48C7??????????E8????????4883????5BC9C30F1F????554889??534883????E8????????488B??????????BA????????89??BF????????E8????????4885??74??66????488B??????????488D????48C7??????????E8????????4883????5BC9C30F1F????554889??534883????E8????????488B??????????BA????????89??BF????????E8????????4885??74??66????488B??????????488D????48C7??????????E8????????4883????5BC9C30F1F????554889?? }

        condition:

            uint16(0) == 0x457f and 
            filesize < 400KB and 
            all of them
}

rule pwnlnx_backdoor_variant_6 {

    meta:
    
        description = "Rule to detect the backdoor pwnlnx variant 6"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "d29254ab907c9ef54349de3ec0dd8b22b4692c58ed7a7b340afbc6e44363f96a"
    
    strings:

        /*

        7F454C4602010100000000000000000001003E00010000000000000000000000000000000000000050740900000000000000000040000000000040002B002800040000001400000003000000474E55002B4D95854AA9AB65223C6152AD3BE5EC9B4BE8F9000000000000000000000000E80000000055488915000000004889E541544989F4534889FB488B3D00000000E8000000004C89E64889DF48C7C200000000FF1500000000488B3D0000000089C3E80000000089D85B415C5DC30F1F00E80000000055488915000000004889E541544989F4534889FB488B3D00000000E8000000004C89E64889DF48C7C200000000FF1500000000488B3D0000000089C3E80000000089D85B415C5DC30F1F00E800000000554889E5415541544989FC534889F34883EC18488B3D0000000065488B042528000000488945E031C0E8000000004889DE4C89E7FF1500000000488B3D000000004189C5E800000000488B0500000000483D00000000488D58F87518EB580F1F440000488B53084881FA00000000488D5AF874420FB713488D7DD448C7C60000000031C0E800000000498B1424498B442418488D75D4488DBC026AFFFFFFBA96000000E8000000004885C074B649816C241896000000488B4DE06548330C25280000004489E8750B4883C4185B415C415D5DC3E8000000000F1F00E800000000554889E5415541544989FC534889F34883EC18488B3D0000000065488B042528000000488945E031C0E8000000004889DE4C89E7FF1500000000488B3D000000004189C5E800000000488B0500000000483D00000000488D58F87518EB580F1F440000488B53084881FA00000000488D5AF874420FB713488D7DD448C7C60000000031C0E800000000498B1424498B442418488D75D4488DBC026AFFFFFFBA96000000E8000000004885C074B649816C241896000000488B4DE06548330C25280000004489E8750B4883C4185B415C415D5DC3E8000000000F1F00E800000000554889E5415541544989FC534889F34883EC18488B3D0000000065488B042528000000488945E031C0E8000000004889DE4C89E7FF1500000000488B3D000000004189C5E800000000488B0500000000483D00000000488D58F87518EB580F1F440000488B53084881FA00000000488D5AF874420FB713488D7DD448C7C60000000031C0E800000000498B1424498B442418488D75D4488DBC026AFFFFFFBA96000000E8000000004885C074B649816C241896000000488B4DE06548330C25280000004489E8750B4883C4185B415C415D5DC3E8000000000F1F00E800000000554889E5415541544989FC534889F34883EC18488B3D0000000065488B042528000000488945E031C0E8000000004889DE4C89E7FF1500000000488B3D000000004189C5E800000000488B0500000000483D00000000488D58F87518EB580F1F440000488B53084881FA00000000488D5AF874420FB713488D7DD448C7C60000000031C0E800000000498B1424498B442418488D75D4488DBC026AFFFFFFBA96000000E8000000004885C074B649816C241896000000488B4DE06548330C25280000004489E8750B4883C4185B415C415D5DC3E8000000000F1F00E800000000554889E541574589CF415641554189D54154534889F34883EC18488B050000000048897DD048894DC84C8945C0483D000000004C8D70F874424C63E2EB150F1F440000498B4608483D000000004C8D70F87428498B364C89E24889DFE80000000085C075DE4883C4185B415C415D415E415F5DC30F1F80000000004589F94C8B45C0488B4DC84489EA4889DE488B7DD0FF15000000004883C4185B415C415D415E415F5DC3660F1F440000E800000000554889E541574589CF41564D89C641554989CD41544189D4BA0A000000534889F3488D75C84883EC1848897DC04889DF65488B042528000000488945D031C0E800000000488B0D000000004881F900000000488D51F8742E0FB749F84839C17514EB600F1F840000000000410FB74AF84839C1744E4C8B52084981FA00000000498D52F875E54589F94D89F04C89E94489E24889DE488B7DC0FF1500000000488B7DD06548333C252800000075194883C4185B415C415D415E415F5DC3660F1F44000031C0EBD8E8000000000F1F440000662E0F1F840000000000E80000000055BF820000C04889E54881EC1002000065488B042528000000488945F831C0488DB5F4FDFFFFFF142500000000B9400000004889C6488DBDF8FDFFFFF348A5488DBDF8FDFFFF48C7C200000000BE00020000B103E8000000004885C0742248BA00000000

        */

        $bp = { 7F??4C4602??01??000000000000000001??3E????000000000000000000000000000000000000??????09??00000000000000004000000000??????2B??28??04??000014??000003??0000474E55????4D9585????AB6522????52AD3B??EC9B4BE8????????0000000000000000????00000000554889??????????4889??41544989??534889??488B??????????E8????????4C89??4889??48C7??????????FF??????????488B??????????89??E8????????89??5B415C5DC30F1F??E8????????554889??????????4889??41544989??534889??488B??????????E8????????4C89??4889??48C7??????????FF??????????488B??????????89??E8????????89??5B415C5DC30F1F??E8????????554889??415541544989??534889??4883????488B??????????65??8B????????????4889????31??E8????????4889??4C89??FF??????????488B??????????4189??E8????????488B??????????483D????????488D????75??EB??0F1F??????488B????4881??????????488D????74??0FB7??488D????48C7??????????31??E8????????498B????498B??????488D????488D????????????BA????????E8????????4885??74??4981??????????????488B????65??33????????????4489??75??4883????5B415C415D5DC3E8????????0F1F??E8????????554889??415541544989??534889??4883????488B??????????65??8B????????????4889????31??E8????????4889??4C89??FF??????????488B??????????4189??E8????????488B??????????483D????????488D????75??EB??0F1F??????488B????4881??????????488D????74??0FB7??488D????48C7??????????31??E8????????498B????498B??????488D????488D????????????BA????????E8????????4885??74??4981??????????????488B????65??33????????????4489??75??4883????5B415C415D5DC3E8????????0F1F??E8????????554889??415541544989??534889??4883????488B??????????65??8B????????????4889????31??E8????????4889??4C89??FF??????????488B??????????4189??E8????????488B??????????483D????????488D????75??EB??0F1F??????488B????4881??????????488D????74??0FB7??488D????48C7??????????31??E8????????498B????498B??????488D????488D????????????BA????????E8????????4885??74??4981??????????????488B????65??33????????????4489??75??4883????5B415C415D5DC3E8????????0F1F??E8????????554889??415541544989??534889??4883????488B??????????65??8B????????????4889????31??E8????????4889??4C89??FF??????????488B??????????4189??E8????????488B??????????483D????????488D????75??EB??0F1F??????488B????4881??????????488D????74??0FB7??488D????48C7??????????31??E8????????498B????498B??????488D????488D????????????BA????????E8????????4885??74??4981??????????????488B????65??33????????????4489??75??4883????5B415C415D5DC3E8????????0F1F??E8????????554889??41574589??415641554189??4154534889??4883????488B??????????4889????4889????4C89????483D????????4C8D????74??4C63??EB??0F1F??????498B????483D????????4C8D????74??498B??4C89??4889??E8????????85??75??4883????5B415C415D415E415F5DC30F1F??????????4589??4C8B????488B????4489??4889??488B????FF??????????4883????5B415C415D415E415F5DC3660F1F??????E8????????554889??41574589??41564D89??41554989??41544189??BA????????534889??488D????4883????4889????4889??65??8B????????????4889????31??E8????????488B??????????4881??????????488D????74??0FB7????4839??75??EB??0F1F????????????410FB7????4839??74??4C8B????4981??????????498D????75??4589??4D89??4C89??4489??4889??488B????FF??????????488B????65??33????????????75??4883????5B415C415D415E415F5DC3660F1F??????31??EB??E8????????0F1F??????662E0F1F????????????E8????????55BF????????4889??4881??????????65??8B????????????4889????31??488D??????????FF????????????B9????????4889??488D??????????F3??A5488D??????????48C7??????????BE????????B1??E8????????4885??74??48BA???????? }

     condition:

        uint16(0) == 0x457f and 
        filesize < 700KB and 
        all of them
}

rule mirai_casper_variant {

    meta:
    
        description = "Rule to detect the Mirai Casper variant"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "57cc422a6a90c571198a2d1c3db13c31fbdb48ba2f0f4356846d6d636d0f9300"
    
    strings:

        /*

		    7F454C460101010300000000000000000200030001000000E08104083400000088250C0000000000340020000500280021001E000100000000000000008004080080040840150C0040150C0005000000001000000100000040150C0040A5100840A51008800C0000904A0000060000000010000004000000D4000000D4800408D4800408440000004400000004000000040000000700000040150C0040A5100840A510081400000030000000040000000400000051E5746400000000000000000000000000000000000000000600000004000000040000001000000001000000474E550000000000020000000600000012000000040000001400000003000000474E550069FB3ADE8762FA5297236F6B2C6C085495C9AB35B8A510082A000000BCA510082A000000C0A510082A000000C4A510082A000000C8A510082A000000CCA510082A0000005589E55383EC04E8000000005B81C358240C008B93FCFFFFFF85D27405E8967EFBF7E811010000E8CC610900585BC9C3FF25B8A510086800000000E900000000FF25BCA510086800000000E900000000FF25C0A510086800000000E900000000FF25C4A510086800000000E900000000FF25C8A510086800000000E900000000FF25CCA510086800000000E900000000000000000000000031ED5E89E183E4F050545268B055060868F0550608515668054C0508E89FCA0100F490909090909090909090909090905589E5538D6424EC803DC0B11008007553BB68A51008A1C4B1100881EB60A51008C1FB0283EB0139D8731D908D74260083C001A3C4B11008FF148560A51008A1C4B1100839D872E8B8D0D60D0885C0740CC704243C7B0F08E863540900C605C0B11008018D6424145B5DC3908D74260055B8D0BC0D0889E58D6424E8E8000000005A81C21B230C0085C074208954240CC744240800000000C7442404C8B11008C704243C7B0F08E8143A0900A16CA5100885C07412B80000000085C07409C704246CA51008FFD0C9C39090905589E583EC288B45088845F4A1E0B1100885C07415A1E0B110080FB655F4881083C001A3E0B11008EB1BC7442408010000008D45F489442404C7042400000000E85FA30100C9C35589E583EC18EB158B45080FB6000FBEC083450801890424E89CFFFFFF8B45080FB60084C075E1C9C35589E583EC488B45080FB6008845F283450801807DF2000F841C030000807DF22574110FBE45F2890424E861FFFFFFE900030000C745E8000000008B45080FB6008845F283450801807DF2307516C745E8010000008B45080FB6008845F283450801EB1A807DF22D7514C745E8020000008B45080FB6008845F283450801C745E400000000EB288B55E489D0C1E00201D001C089C20FBE45F28D040283E8308945E48B45080FB6008845F283450801807DF22F7E06807DF2397ECC807DF26C7406807DF24C7511834DE8048B45080FB6008845F283450801807DF2000F845A0200000FB645F28845F3807DF3607E0A0FB645F383E8208845F30FBE45F383E84283F8160F87CB0000008B0485ECFD0D08FFE08B450C8D500489550C8B008945F4C745E000000000EB048345E0018B45E08B55F48D04020FB60084C075ECEB0CC7042420000000E845FEFFFF8B45E883E00285C075118B45E03B45E40F92C08345E00184C075D98B45F4890424E866FEFFFFEB0CC7042420000000E811FEFFFF8B45E03B45E40F92C08345E00184C075E3E99F0100008B450C8D500489550C8B000FBEC0890424E8E5FDFFFFE984010000C745D802000000EB2CC745D808000000EB23C745D80A000000EB1AC745D810000000EB110FBE45F2890424E8B0FDFFFFE94F0100008B45E883E00485C0740D8B450C8D500489550C8B00EB1E807DF344750D8B450C8D500489550C8B00EB0B8B450C8D500489550C8B008945EC807DF344750E8B45EC85C07907F75DEC834DE808C745DC000000008B45ECBA00000000F775D889D08845F38B45ECBA00000000F775D88945EC807DF3097E1B807DF2787507B827000000EB05B8070000000FB655F301D08845F38B45DC0FB655F383C230885405C88345DC01837DEC007406837DDC0F76A38B45E883E00885C0740C8B45DCC64405C82D8345DC018B45DC8945E08B45E883E00184C07407B830000000EB05B8200000008845F3EB0C0FBE45F3890424E8B8FCFFFF8B45E883E00285C075118B45E03B45E40F92C08345E00184C075D9836DDC018B45DC0FB64405C80FBEC0890424E886FCFFFF837DDC0075E3EB0CC7042420000000E872FCFFFF8B45E03B45E40F92C08345E00184C075E3E9D2FCFFFFE9CDFCFFFF90EB0190C9C35589E583EC288D450C8945F48B45F4894424048B4508890424E8A3FCFFFFC9C35589E583EC088B55088B45108855FC8845F8C9C35589E557565381EC1C5200008B55088B4510889504AEFFFF888500AEFFFFC7853CFFFFFF00000000C78540FFFFFF000000000FB68500AEFFFFC744240C00000000C7442408150000008B551489542404890424E85D450000898544FFFFFF0FB68500AEFFFFC744240C48FE0D08C7442408140000008B551489542404890424E831450000898548FFFFFF0FB68500AEFFFFC744240C00000000C7442408080000008B551489542404890424E80545000089854CFFFFFF0FB68500AEFFFFC744240C4CFE0D08C7442408160000008B551489542404890424E8D9440000898550FFFFFF0FB68500AEFFFFC744240C01000000C7442408180000008B551489542404890424E8F9440000898554FFFFFF0FB68500AEFFFFC744240C50000000C7442408070000008B551489542404890424E8CD4400006689855AFFFFFF8D852FD7FFFFBA0128000089542408C744240400000000890424E89FF9FFFF83BD4CFFFFFF000F84DE2B000083BD50FFFFFF000F84D42B00008B8550FFFFFF890424E85E1401003DFF0000000F8FBE2B00008B854CFFFFFF890424E84514010083F87F0F8FAA2B00008B8548FFFFFF890424E82E14010083F8090F8F962B0000C78530FFFFFF00000000EB558B8530FFFFFF038548FFFFFF0FB6003C607E338B8530FFFFFF038548FFFFFF0FB6003C7A7F208B8530FFFFFF038548FFFFFF8B9530FFFFFF039548FFFFFF0FB61283EA2088108B8530FFFFFF83C001898530FFFFFF8B8548FFFFFF890424E8B61301008B9530FFFFFF39D07F9381BD54FFFFFFE80300007E0AC78554FFFFFFE8030000C7042424000000E8B20D0100C7042425000000E8A60D0100C7042426000000E89A0D0100C7042427000000E88E0D0100C7042428000000E8820D0100C7042429000000E8760D0100C704242A000000E86A0D0100C704242B000000E85E0D0100C704242C000000E8520D0100C704242D000000E8460D0100C704242E000000E83A0D01008B8554FFFFFFC7442404440C0000890424E8ADBB0200898540FFFFFFC78534FFFFFF00000000E95E0400008B8534FFFFFF69C0440C0000038540FFFFFFC64004008B8534FFFFFF69C0440C0000038540FFFFFFC700FFFFFFFF8B8534FFFFFF69C0440C000089C1038D40FFFFFF0FB69D04AEFFFF8B8534FFFFFF89C2C1FA1FF7FB89D089C289D001C001D0C1E00303450C8B40108941108B8534FFFFFF69C0440C0000038540FFFFFF8D90140200008B8550FFFFFF89442404891424E85C1301008B8534FFFFFF69C0440C0000038540FFFFFF0FB680140200003C2F747B8B8534FFFFFF69C0440C0000038540FFFFFF0514020000890424E8151201008B9534FFFFFF69D2440C0000039540FFFFFF8D8A140200008B9534FFFFFF69D2440C0000039540FFFFFF81C21402000083C20189442408894C2404891424E8ABF6FFFF8B8534FFFFFF69C0440C0000038540FFFFFFC680140200002F8B8534FFFFFF69C0440C0000038540FFFFFF8D90A00500008B8548FFFFFF89442404891424E89A1201008B8534FFFFFF69C0440C0000038540FFFFFF8D90970500008B8548FFFFFF89442404891424E8701201008B8534FFFFFF69C0440C0000038540FFFFFF8D90150300008B854CFFFFFF89442404891424E8461201000FB68D04AEFFFF8B8534FFFFFF89C2C1FA1FF7F989D089C289D001C001D0C1E00303450C0FB640143C1F0F878D0000008B8534FFFFFF69C0440C000089C3039D40FFFFFF0FB68D04AEFFFF8B8534FFFFFF89C2C1FA1FF7F989D089C289D001C001D0C1E00303450C8B4010890424E859CE030089C6E85EDD000089C70FB68D04AEFFFF8B8534FFFFFF89C2C1FA1FF7F989D089C289D001C001D0C1E00303450C0FB640140FB6C089FA89C1D3EA89D08D0406890424E812CE0300894310E816DD000089C1BACDCCCCCC89C8F7E289D0C1E80289C2C1E20201C289C829D083F8040F879B0100008B04859CFE0D08FFE0C704242F000000E8680A0100C744240400000000C704242F000000E8C20A01008B9534FFFFFF69D2440C0000039540FFFFFF83C21489442404891424E816110100C704242F000000E85E0A0100E940010000C7042430000000E8160A0100C744240400000000C7042430000000E8700A01008B9534FFFFFF69D2440C0000039540FFFFFF83C21489442404891424E8C4100100C7042430000000E80C0A0100E9EE000000C7042431000000E8C4090100C744240400000000C7042431000000E81E0A01008B9534FFFFFF69D2440C0000039540FFFFFF83C21489442404891424E872100100C7042431000000

		    */

        $bp = { 7F??4C4601??01??000000000000000002??03??01??0000E0??04??34??000088??????????000034??20??05????????????????000000000000000080??????80??????15????????0C??05????????10??????0000??????0C??40A510??40A510??80??????904A0000060000000010????????0000D4??0000D4??04??D4??04??440000??????????????000004??0000070000??????0C??40A510??40A510??14??000030??000004??000004??000051E5??64????000000000000000000000000000000000000060000??????000004??000010??000001??0000474E5500000000????0000????0000????0000??????000014??000003??0000474E55??????3A??87????529723????2C??08??????AB35????????2A??0000BC????????0000????A510??2A??0000C4??????????0000C8??????2A??0000CCA510??2A??00005589??5383????E8????????5B81??????????8B??????????85??74??E8????????E8????????E8????????585BC9C3FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????FF??????????68????????E9????????000000000000000031??5E89??83????50545268????????68????????515668????????E8????????F490909090909090909090909090905589??538D??????80????????????75??BB????????A1????????81??????????C1????83????39??73??908D??????83????A3????????FF????????????A1????????39??72??B8????????85??74??C7????????????E8????????C6????????????8D??????5B5DC3908D??????55B8????????89??8D??????E8????????5A81??????????85??74??89??????C7??????????????C7??????????????C7????????????E8????????A1????????85??74??B8????????85??74??C7????????????FF??C9C39090905589??83????8B????88????A1????????85??74??A1????????0FB6????88??83????A3????????EB??C7??????????????8D????89??????C7????????????E8????????C9C35589??83????EB??8B????0FB6??0FBE??83??????89????E8????????8B????0FB6??84??75??C9C35589??83????8B????0FB6??88????83??????80??????0F84????????80??????74??0FBE????89????E8????????E9????????C7????????????8B????0FB6??88????83??????80??????75??C7????????????8B????0FB6??88????83??????EB??80??????75??C7????????????8B????0FB6??88????83??????C7????????????EB??8B????89??C1????01??01??89??0FBE????8D????83????89????8B????0FB6??88????83??????80??????7E??80??????7E??80??????74??80??????75??83??????8B????0FB6??88????83??????80??????0F84????????0FB6????88????80??????7E??0FB6????83????88????0FBE????83????83????0F87????????8B????????????FF??8B????8D????89????8B??89????C7????????????EB??83??????8B????8B????8D????0FB6??84??75??EB??C7????????????E8????????8B????83????85??75??8B????3B????0F92??83??????84??75??8B????89????E8????????EB??C7????????????E8????????8B????3B????0F92??83??????84??75??E9????????8B????8D????89????8B??0FBE??89????E8????????E9????????C7????????????EB??C7????????????EB??C7????????????EB??C7????????????EB??0FBE????89????E8????????E9????????8B????83????85??74??8B????8D????89????8B??EB??80??????75??8B????8D????89????8B??EB??8B????8D????89????8B??89????80??????75??8B????85??79??F7????83??????C7????????????8B????BA????????F7????89??88????8B????BA????????F7????89????80??????7E??80??????75??B8????????EB??B8????????0FB6????01??88????8B????0FB6????83????88??????83??????83??????74??83??????76??8B????83????85??74??8B????C6????????83??????8B????89????8B????83????84??74??B8????????EB??B8????????88????EB??0FBE????89????E8????????8B????83????85??75??8B????3B????0F92??83??????84??75??83??????8B????0FB6??????0FBE??89????E8????????83??????75??EB??C7????????????E8????????8B????3B????0F92??83??????84??75??E9????????E9????????90EB??90C9C35589??83????8D????89????8B????89??????8B????89????E8????????C9C35589??83????8B????8B????88????88????C9C35589??57565381??????????8B????8B????88??????????88??????????C7??????????????????C7??????????????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????89??????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????89??????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????89??????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????89??????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????89??????????0FB6??????????C7??????????????C7??????????????8B????89??????89????E8????????66????????????8D??????????BA????????89??????C7??????????????89????E8????????83????????????0F84????????83????????????0F84????????8B??????????89????E8????????3D????????0F8F????????8B??????????89????E8????????83????0F8F????????8B??????????89????E8????????83????0F8F????????C7??????????????????EB??8B??????????03??????????0FB6??3C??7E??8B??????????03??????????0FB6??3C??7F??8B??????????03??????????8B??????????03??????????0FB6??83????88??8B??????????83????89??????????8B??????????89????E8????????8B??????????39??7F??81??????????????????7E??C7??????????????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????C7????????????E8????????8B??????????C7??????????????89????E8????????89??????????C7??????????????????E9????????8B??????????69??????????03??????????C6??????8B??????????69??????????03??????????C7??????????8B??????????69??????????89??03??????????0FB6??????????8B??????????89??C1????F7??89??89??89??01??01??C1????03????8B????89????8B??????????69??????????03??????????8D??????????8B??????????89??????89????E8????????8B??????????69??????????03??????????0FB6??????????3C??74??8B??????????69??????????03??????????05????????89????E8????????8B??????????69??????????03??????????8D??????????8B??????????69??????????03??????????81??????????83????89??????89??????89????E8????????8B??????????69??????????03??????????C6????????????8B??????????69??????????03??????????8D??????????8B??????????89??????89????E8????????8B??????????69??????????03??????????8D??????????8B??????????89??????89????E8????????8B??????????69??????????03??????????8D??????????8B??????????89??????89????E8????????0FB6??????????8B??????????89??C1????F7??89??89??89??01??01??C1????03????0FB6????3C??0F87????????8B??????????69??????????89??03??????????0FB6??????????8B??????????89??C1????F7??89??89??89??01??01??C1????03????8B????89????E8????????89??E8????????89??0FB6??????????8B??????????89??C1????F7??89??89??89??01??01??C1????03????0FB6????0FB6??89??89??D3??89??8D????89????E8????????89????E8????????89??BA????????89??F7??89??C1????89??C1????01??89??29??83????0F87????????8B????????????FF??C7????????????E8????????C7??????????????C7????????????E8????????8B??????????69??????????03??????????83????89??????89????E8????????C7????????????E8????????E9????????C7????????????E8????????C7??????????????C7????????????E8????????8B??????????69??????????03??????????83????89??????89????E8????????C7????????????E8????????E9????????C7????????????E8????????C7??????????????C7????????????E8????????8B??????????69??????????03??????????83????89??????89????E8????????C7???????????? }

    condition:

       uint16(0) == 0x457f and
       filesize < 3000KB and 
       all of them
}


rule APT_stolen_certificates {

    meta:

        description = "Rule to detect samples digitally signed from these stolen certificates"
        author = "Marc Rivero | McAfee ATR Team"
        date = "2020-04-17"
        rule_version = "v1"
        malware_type = "backdoor"
        malware_family = "Backdoor:W32/Pwnlnx"
        actor_type = "Cybercrime"
        actor_group = "Unknown"
        reference = "https://www.blackberry.com/content/dam/blackberry-com/asset/enterprise/pdf/direct/report-bb-decade-of-the-rats.pdf"
        hash = "ce3424524fd1f482a0339a3f92e440532cff97c104769837fa6ae52869013558"
        
    condition:

      uint16(0) == 0x5a4d and
      for any i in (0 .. pe.number_of_signatures) : (
         pe.signatures[i].subject contains "/C=KR/ST=Seoul/L=Gangnam-gu/O=LivePlex Corp/CN=LivePlex Corp"  and
         pe.signatures[i].serial == "3f:55:42:e2:e7:1d:8d:b3:57:04:1c:9d:d4:5b:95:0a" or
         pe.signatures[i].subject contains "/C=KR/ST=Seoul/L=Gangnam-gu/O=LivePlex Corp/CN=LivePlex Corp"  and
         pe.signatures[i].serial == "3f:55:42:e2:e7:1d:8d:b3:57:04:1c:9d:d4:5b:95:0a" or
         pe.signatures[i].subject contains "/C=KR/ST=Seoul/L=Gangnam-gu/O=LivePlex Corp/CN=LivePlex Corp" or
         pe.signatures[i].serial == "3f:55:42:e2:e7:1d:8d:b3:57:04:1c:9d:d4:5b:95:0a")
}
